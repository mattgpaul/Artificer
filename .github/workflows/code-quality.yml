name: Code Quality

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

# Optimize Bazel caching and performance
env:
  BAZEL_CACHE_DIR: ~/.cache/bazel
  BAZELISK_CACHE_DIR: ~/.cache/bazelisk

jobs:
  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # Cache Bazel artifacts for massive speedup
      - name: Cache Bazel
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/bazel
            ~/.cache/bazelisk
          # Cache key based on lock files - invalidates when dependencies change
          key: ${{ runner.os }}-bazel-lint-${{ hashFiles('MODULE.bazel.lock', 'requirements.txt', '.bazelversion') }}
          # Fallback to most recent cache if exact match not found
          restore-keys: |
            ${{ runner.os }}-bazel-lint-
            ${{ runner.os }}-bazel-
      
      - name: Setup Bazel
        uses: bazel-contrib/setup-bazel@0.8.1
        with:
          bazelisk-cache: true
          disk-cache: ${{ github.workflow }}
          repository-cache: true
      
      # Configure Bazel for optimal CI performance
      - name: Configure Bazel
        run: |
          cat >> ~/.bazelrc << EOF
          # CI-specific optimizations
          build --jobs=auto
          build --local_resources=cpu=HOST_CPUS
          build --local_resources=memory=HOST_RAM*.8
          build --noshow_progress
          build --show_result=0
          build --color=yes
          
          # Remote cache ready (uncomment when configured)
          # build --remote_cache=https://storage.googleapis.com/your-bucket
          # build --experimental_remote_cache_compression
          # build --experimental_remote_download_minimal
          
          # Improve caching
          build --experimental_reuse_sandbox_directories
          build --incompatible_strict_action_env
          EOF
      
      - name: Check code quality
        run: |
          echo "ðŸ” Running linter checks..."
          bazel run //:lint
      
      - name: Verify Python formatting (no changes)
        run: |
          echo "ðŸ“ Verifying code formatting..."
          bazel run //:ruff -- format --check .
      
      # Report cache statistics for monitoring
      - name: Bazel cache stats
        if: always()
        run: |
          echo "ðŸ“Š Bazel Cache Statistics:"
          du -sh ~/.cache/bazel 2>/dev/null || echo "Cache not found"
          echo "Total files in cache: $(find ~/.cache/bazel -type f 2>/dev/null | wc -l)"
  
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # Restore Bazel cache - can reuse from lint job
      - name: Cache Bazel
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/bazel
            ~/.cache/bazelisk
          key: ${{ runner.os }}-bazel-test-${{ hashFiles('MODULE.bazel.lock', 'requirements.txt', '.bazelversion') }}
          restore-keys: |
            ${{ runner.os }}-bazel-test-
            ${{ runner.os }}-bazel-lint-
            ${{ runner.os }}-bazel-
      
      - name: Setup Bazel
        uses: bazel-contrib/setup-bazel@0.8.1
        with:
          bazelisk-cache: true
          disk-cache: ${{ github.workflow }}
          repository-cache: true
      
      # Configure Bazel for optimal CI performance
      - name: Configure Bazel
        run: |
          cat >> ~/.bazelrc << EOF
          # CI-specific optimizations
          build --jobs=auto
          build --local_resources=cpu=HOST_CPUS
          build --local_resources=memory=HOST_RAM*.8
          test --test_output=errors
          test --test_summary=detailed
          test --noshow_progress
          test --color=yes
          
          # Remote cache ready (uncomment when configured)
          # build --remote_cache=https://storage.googleapis.com/your-bucket
          # build --experimental_remote_cache_compression
          # build --experimental_remote_download_minimal
          
          # Improve caching and test performance
          test --experimental_reuse_sandbox_directories
          test --incompatible_strict_action_env
          test --build_tests_only
          EOF
      
      - name: Run all tests
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref_name }}" = "main" ]; then
            echo "ðŸ§ª Push to main: running full test suite..."
            bazel test //... --test_output=errors
            exit 0
          fi

          echo "ðŸ§ª PR to main: running system-scoped tests (impacted systems only)..."

          # Compute changed files for PR
          git fetch --no-tags origin "${{ github.base_ref }}" --depth=1 || true
          CHANGED_FILES=$(git diff --name-only "origin/${{ github.base_ref }}"...HEAD || true)
          echo "$CHANGED_FILES" > /tmp/changed_files.txt

          # Discover systems dynamically from repo
          mapfile -t ALL_SYSTEMS < <(find system -maxdepth 1 -mindepth 1 -type d -printf '%f\n' | sort)
          IMPACTED_SYSTEMS=()

          if grep -q '^infrastructure/' /tmp/changed_files.txt; then
            # Shared infra change: treat as impacting all systems
            IMPACTED_SYSTEMS=("${ALL_SYSTEMS[@]}")
          else
            for SYS in "${ALL_SYSTEMS[@]}"; do
              if grep -q "^system/${SYS}/" /tmp/changed_files.txt; then
                IMPACTED_SYSTEMS+=("$SYS")
              fi
            done
          fi

          if [ "${#IMPACTED_SYSTEMS[@]}" -eq 0 ]; then
            echo "No system/ or infrastructure/ changes detected; skipping system tests."
            exit 0
          fi

          echo "Impacted systems: ${IMPACTED_SYSTEMS[*]}"

          # Run tests for impacted systems only (if the tests package exists)
          for SYS in "${IMPACTED_SYSTEMS[@]}"; do
            if [ -d "tests/system/${SYS}" ]; then
              echo "Running tests for system: ${SYS}"
              bazel test "//tests/system/${SYS}/..." --test_output=errors
            else
              echo "No tests found under tests/system/${SYS}; skipping."
            fi
          done
      
      # Upload test results for visibility
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: bazel-testlogs/
          retention-days: 7
      
      # Report test and cache statistics
      - name: Test and cache stats
        if: always()
        run: |
          echo "ðŸ“Š Test Statistics:"
          # Avoid re-running the entire test suite here; that defeats PR scoping.
          # Just show Bazel/cache stats.
          echo ""
          echo "ðŸ“Š Bazel Cache Statistics:"
          du -sh ~/.cache/bazel 2>/dev/null || echo "Cache not found"
          echo "Total files in cache: $(find ~/.cache/bazel -type f 2>/dev/null | wc -l)"
      
      # Generate coverage report (optional)
      - name: Generate coverage report
        if: github.event_name == 'pull_request'
        run: |
          echo "ðŸ“ˆ Generating coverage report..."
          bazel coverage //... --combined_report=lcov || true
        continue-on-error: true

