load("@pip//:requirements.bzl", "requirement")
load("@rules_pkg//:pkg.bzl", "pkg_tar")

# Config library for algo_trader system
py_library(
    name = "config",
    srcs = ["config.py"],
    visibility = [
        "//system/algo_trader:__subpackages__",
        "//tests/system/algo_trader:__subpackages__",
    ],
    deps = [
        "//infrastructure:config",
        requirement("pydantic"),
        requirement("pydantic-settings"),
    ],
)

# Project aggregation target - collects all algo_trader components
py_library(
    name = "library",
    tags = [
        "algo_trader",
        "system",
    ],
    visibility = [
        "//system:__pkg__",  # Available to system package
    ],
    deps = [
        ":config",
        "//system/algo_trader/redis:redis_services",
        "//system/algo_trader/schwab:schwab_services",
        "//system/algo_trader/service/market_data:market_data_lib",
        "//system/algo_trader/utils:schema",
    ],
)

# Release images: all OCI image tarballs for this system
filegroup(
    name = "release_images",
    srcs = [
        "//infrastructure/grafana:grafana_tarball",
        "//infrastructure/influxdb:influxdb3_tarball",
        "//infrastructure/mysql:mysql_tarball",
        "//infrastructure/redis:redis_tarball",
        "//system/algo_trader/influx:publisher_tarball",
        "//system/algo_trader/mysql:mysql_daemon_tarball",
    ],
    visibility = ["//visibility:public"],
)

# Release bundle: deploy files + manifest
# Manifest will be generated by CI with version info
genrule(
    name = "release_manifest_template",
    srcs = [],
    outs = ["release_manifest.json.template"],
    cmd = """cat > $@ <<'EOF'
{
  "system": "algo_trader",
  "version": "${VERSION}",
  "images": [
    {"name": "artificer-redis", "tarball": "artificer-redis.tar"},
    {"name": "artificer-influxdb", "tarball": "artificer-influxdb.tar"},
    {"name": "artificer-grafana", "tarball": "artificer-grafana.tar"},
    {"name": "artificer-mysql", "tarball": "artificer-mysql.tar"},
    {"name": "artificer-influx-publisher", "tarball": "artificer-influx-publisher.tar"},
    {"name": "artificer-mysql-daemon", "tarball": "artificer-mysql-daemon.tar"}
  ],
  "deploy_files": [
    "docker-compose.yaml",
    "grafana/provisioning/dashboards/dashboard-provider.yaml",
    "grafana/provisioning/dashboards/backtest-summary.json",
    "grafana/provisioning/dashboards/ohlcv-dashboard.json",
    "grafana/provisioning/dashboards/trading-journal.json",
    "grafana/provisioning/datasources/dev-backtest.yaml",
    "grafana/provisioning/datasources/journal.yaml",
    "grafana/provisioning/datasources/ohlcv.yaml",
    "influx/publisher_config.yaml"
  ]
}
EOF""",
)

# Bundle all deploy files
pkg_tar(
    name = "release_bundle_files",
    srcs = glob(["grafana/provisioning/**/*"]) + [
        "docker-compose.yaml",
        "influx/publisher_config.yaml",
    ],
    package_dir = "algo_trader",
    strip_prefix = "system/algo_trader",
    visibility = ["//visibility:private"],
)

# Release bundle tarball (includes manifest placeholder - CI will inject version)
pkg_tar(
    name = "release_bundle",
    srcs = [":release_manifest_template"],
    package_dir = "algo_trader",
    visibility = ["//visibility:public"],
    deps = [":release_bundle_files"],
)

# Meta release target
alias(
    name = "release",
    actual = ":release_bundle",
    visibility = ["//visibility:public"],
)
