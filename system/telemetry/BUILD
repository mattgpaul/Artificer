# BUILD file for telemetry monitoring system
# This package contains Prometheus configs, Grafana provisioning, and Docker Compose setup

load("@rules_pkg//:pkg.bzl", "pkg_tar")

filegroup(
    name = "prometheus_config",
    srcs = glob([
        "prometheus/**/*.yml",
        "prometheus/**/*.yaml",
    ]),
    visibility = ["//tests/system/telemetry:__pkg__"],
)

filegroup(
    name = "grafana_provisioning",
    srcs = glob([
        "grafana/provisioning/**/*.yaml",
        "grafana/provisioning/**/*.json",
    ]),
    visibility = ["//tests/system/telemetry:__pkg__"],
)

filegroup(
    name = "docker_compose",
    srcs = ["ops/docker-compose.yaml"],
    visibility = ["//visibility:public"],
)

# Convenience target so `bazel test //system/telemetry/...` runs the system's tests.
test_suite(
    name = "tests",
    tests = [
        "//tests/system/telemetry:test_grafana_assets",
        "//tests/system/telemetry:test_prometheus_config",
    ],
    visibility = ["//visibility:public"],
)

# Release images: all OCI image tarballs for this system
filegroup(
    name = "release_images",
    srcs = [
        "//infrastructure/grafana:grafana_tarball",
        "//infrastructure/node_exporter:node_exporter_tarball",
        "//infrastructure/prometheus:prometheus_tarball",
    ],
    visibility = ["//visibility:public"],
)

# Release bundle: deploy files + manifest
# Manifest will be generated by CI with version info
genrule(
    name = "release_manifest_template",
    srcs = [],
    outs = ["release_manifest.json.template"],
    cmd = """cat > $@ <<'EOF'
{
  "system": "telemetry",
  "version": "$${VERSION}",
  "images": [
    {"name": "artificer-prometheus", "tarball": "artificer-prometheus.tar"},
    {"name": "artificer-grafana", "tarball": "artificer-grafana.tar"},
    {"name": "artificer-node-exporter", "tarball": "artificer-node-exporter.tar"}
  ],
  "deploy_files": [
    "ops/docker-compose.yaml",
    "prometheus/prometheus.yml",
    "prometheus/targets/node-exporters.yaml",
    "grafana/provisioning/dashboards/dashboard-provider.yaml",
    "grafana/provisioning/dashboards/telemetry-overview.json",
    "grafana/provisioning/datasources/prometheus.yaml"
  ]
}
EOF""",
)

# Bundle all deploy files
pkg_tar(
    name = "release_bundle_files",
    srcs = [
        ":docker_compose",
        ":grafana_provisioning",
        ":prometheus_config",
    ] + glob([
        "prometheus/**/*",
        "grafana/provisioning/**/*",
        "gpu/**/*",
        "processes/**/*",
        "ops/**/*",
    ]),
    package_dir = "telemetry",
    strip_prefix = "system/telemetry",
    visibility = ["//visibility:private"],
)

# Release bundle tarball (includes manifest placeholder - CI will inject version)
pkg_tar(
    name = "release_bundle",
    srcs = [":release_manifest_template"],
    package_dir = "telemetry",
    visibility = ["//visibility:public"],
    deps = [":release_bundle_files"],
)

# Meta release target: build both image tarballs and deploy bundle
filegroup(
    name = "release",
    srcs = [
        ":release_bundle",
        ":release_images",
    ],
    visibility = ["//visibility:public"],
)
